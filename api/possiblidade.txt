async function verAlunosNotas(id_sala, id_disciplina) {
    const notasContainer = document.getElementById("notas-disciplina-container");
    notasContainer.innerHTML = '<p>Carregando notas...</p>';

    const resposta = await fetch("../api/func_sala_resp.php?acao=alunosNotasDisciplina", {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id_sala, id_disciplina })
    });
    const dados = await resposta.json();

    let htmlConteudo = '';
    if (dados && dados.length > 0) {
        htmlConteudo += `
            <button id="salvar-notas" class="salvar-notas">Salvar alterações</button>
            <table class="tabela-notas">
                <thead>
                    <tr>
                        <th>Matrícula</th>
                        <th>Nome do Aluno</th>
                        <th>1º Bimestre</th>
                        <th>2º Bimestre</th>
                        <th>3º Bimestre</th>
                        <th>4º Bimestre</th>
                    </tr>
                </thead>
                <tbody>
        `;
        dados.forEach(aluno => {
            htmlConteudo += `
                <tr>
                    <td>${aluno.matricula}</td>
                    <td>${aluno.nome_aluno}</td>
                    <td><input type="text" class="nota-input" data-matricula="${aluno.matricula}" data-bimestre="1" value="${aluno.bimestre_1 ?? ''}"></td>
                    <td><input type="text" class="nota-input" data-matricula="${aluno.matricula}" data-bimestre="2" value="${aluno.bimestre_2 ?? ''}"></td>
                    <td><input type="text" class="nota-input" data-matricula="${aluno.matricula}" data-bimestre="3" value="${aluno.bimestre_3 ?? ''}"></td>
                    <td><input type="text" class="nota-input" data-matricula="${aluno.matricula}" data-bimestre="4" value="${aluno.bimestre_4 ?? ''}"></td>
                </tr>
            `;
        });
        htmlConteudo += `</tbody></table>`;
    } else {
        htmlConteudo += '<p>Nenhum aluno com notas encontrado para esta disciplina.</p>';
    }
    notasContainer.innerHTML = htmlConteudo;

    // Adiciona o event listener ao botão após ele existir no DOM
    const btnSalvar = document.getElementById("salvar-notas");
    if (btnSalvar) {
        btnSalvar.addEventListener("click", async () => {
            // Agrupa notas por aluno
            const notasPorAluno = {};
            document.querySelectorAll('.nota-input').forEach(input => {
                const matricula = input.getAttribute('data-matricula');
                const bimestre = input.getAttribute('data-bimestre');
                const valor = input.value;
                if (!notasPorAluno[matricula]) notasPorAluno[matricula] = {};
                notasPorAluno[matricula][bimestre] = valor;
            });

            // Envia cada aluno separadamente
            for (const matricula in notasPorAluno) {
                const lista_valores = [
                    notasPorAluno[matricula]['1'] || null,
                    notasPorAluno[matricula]['2'] || null,
                    notasPorAluno[matricula]['3'] || null,
                    notasPorAluno[matricula]['4'] || null
                ];
                await salvarNotas(matricula, id_sala, id_disciplina, lista_valores);
            }
            alert("Notas salvas!");
            verAlunosNotas(id_sala, id_disciplina); // Atualiza a tabela
        });
    }

    
async function salvarNotas(matricula, id_sala, id_disciplina, lista_valores) {
    await fetch("../api/func_sala_resp.php?acao=salvarNotas", {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            matricula: matricula,
            id_sala: id_sala,
            id_disciplina: id_disciplina,
            valor: lista_valores
        })
    });
}
