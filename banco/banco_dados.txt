create database if not exists gestao_escolar_k
default character set utf8mb4
default collate utf8mb4_unicode_ci;

use gestao_escolar_k;

create table cargo (
    id_cargo int auto_increment primary key,
    nome_cargo varchar(50) not null unique,
    nivel int not null
);

insert into cargo (nome_cargo, nivel) values ("adm", 5);

create table usuario (
    id_user int auto_increment primary key,
    nome_usuario varchar(100) not null,
    email varchar(150) unique,
    senha varchar(255) not null,
    conta_ativa tinyint(1) default 1,
    id_cargo int not null,
    foreign key (id_cargo) references cargo(id_cargo)
);

insert into usuario (nome_usuario, email, senha, id_cargo) values
("adm", "adm", 1234, 1);

create table sala (
    id_sala int auto_increment primary key,
    nome_sala varchar(50) not null,
    capacidade int not null,
    data_criacao datetime default current_timestamp,
    id_responsavel int,
	FOREIGN KEY (id_responsavel) references usuario(id_user)
);

create table aluno (
    matricula int auto_increment primary key,
    nome varchar(100) not null,
    genero varchar(15) not null,
    data_nascimento date not null,
    conta_ativa tinyint(1) default 1,
    id_sala int,
    foreign key (id_sala) references sala(id_sala)
);

create table disciplina (
    id_disciplina int auto_increment primary key,
    nome varchar(100) not null
);

insert into disciplina (id_disciplina, nome) values
(1, "matematica"),
(2, "portugues"),
(3, "geografia"),
(4, "historia");


create table sala_disciplina (
    id_sala int,
    id_disciplina int,
	id_professor int,
    primary key (id_sala, id_disciplina),
    foreign key (id_sala) references sala(id_sala),
	FOREIGN KEY (id_professor) references usuario(id_user),
    foreign key (id_disciplina) references disciplina(id_disciplina)
);

create table nota (
    id_nota int auto_increment primary key,
    matricula int not null,
    id_sala int not null,
    id_disciplina int not null,
    bimestre tinyint not null, -- 1 a 4
    valor decimal(5,2) not null,
    data_registro datetime default current_timestamp,
	UNIQUE KEY uk_nota_bimestre (matricula, id_disciplina, bimestre),
    foreign key (matricula) references aluno(matricula),
    foreign key (id_sala, id_disciplina) references sala_disciplina(id_sala, id_disciplina)
);

create table presenca (
    id_presenca int auto_increment primary key,
    matricula int not null,
    data_presenca date not null,
    id_disciplina int,
    presente tinyint(1) not null,
    foreign key (matricula) references aluno(matricula),
	foreign key (id_disciplina) references sala_disciplina(id_disciplina)
);